{% extends "base.html" %}

{% block title %}Iniciar Nueva Tarea - Aplicación de Seguimiento de Producción{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/start_new_task.css') }}">
{% endblock %}

{% block content %}
<button class="back-arrow" onclick="window.history.back()">←</button>
<h1 class="task-title">Iniciar Nueva Tarea</h1>
<form action="{{ url_for('main.start_new_task') }}" method="post">
    <div class="mb-4">
        <label class="form-label">Proyecto:</label>
        <div class="radio-group">
            {% for project in projects %}
                <div>
                    <input type="radio" name="project" id="project{{ loop.index }}" value="{{ project }}" {% if project == last_project|default('') %}checked{% endif %} required>
                    <label for="project{{ loop.index }}">{{ project }}</label>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="mb-4">
        <label for="houseNumber" class="form-label">Número de Casa:</label>
        <input type="number" id="houseNumber" name="house_number" class="form-control" required min="1" value="{{ last_house_number }}">
    </div>

    <div class="mb-4">
        <label class="form-label">Nº módulo:</label>
        <div id="moduloButtons" class="radio-group">
            {% for i in range(1, num_modulos + 1) %}
                <div>
                    <input type="radio" name="n_modulo" id="modulo{{ i }}" value="{{ i }}" {% if i == (last_n_modulo|default(1)|int) %}checked{% endif %} required>
                    <label for="modulo{{ i }}">{{ i }}</label>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="mb-4">
        <label for="activity" class="form-label">Actividad:</label>
        <select name="activity" id="activity" class="form-select" required>
            <option value="">Seleccionar actividad</option>
        </select>
        <div class="form-check form-switch mb-2 mt-3">
            <input class="form-check-input" type="checkbox" id="showOtherActivities" style="transform: scale(1.5);">
            <label class="form-check-label" for="showOtherActivities" style="font-size: 1.2em; margin-left: 10px;">Mostrar actividades fuera de mi especialidad</label>
        </div>
    </div>

    {% if frequent_tasks %}
    <div class="mb-4">
        <label class="form-label">Tareas frecuentes:</label>
        <div class="frequent-tasks">
            {% for task in frequent_tasks %}
            <form action="{{ url_for('main.start_new_task') }}" method="post" class="d-inline frequent-task-form">
                <input type="hidden" name="project" value="{{ last_project }}">
                <input type="hidden" name="house_number" value="{{ last_house_number }}">
                <input type="hidden" name="n_modulo" value="{{ last_n_modulo }}">
                <input type="hidden" name="activity" value="{{ task }}">
                <button type="submit" class="btn btn-outline-primary frequent-task-btn">{{ task }}</button>
            </form>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <button type="submit" class="btn btn-primary w-100">Iniciar Tarea</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const activitySelect = document.getElementById('activity');
        const showOtherActivitiesCheckbox = document.getElementById('showOtherActivities');
        const frequentTaskForms = document.querySelectorAll('.frequent-task-form');
        
        const userActivities = {{ user_activities|tojson }};
        const otherActivities = {{ other_activities|tojson }};

        function updateActivityOptions(showOther) {
            activitySelect.innerHTML = '<option value="">Seleccionar actividad</option>';
            const activities = showOther ? otherActivities : userActivities;
            activities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity;
                option.textContent = activity;
                activitySelect.appendChild(option);
            });
        }

        updateActivityOptions(false);

        showOtherActivitiesCheckbox.addEventListener('change', function() {
            updateActivityOptions(this.checked);
        });

        // Handle frequent task button clicks
        document.querySelectorAll('.frequent-task-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const form = this.closest('form');
                
                // Get the activity value from the hidden input
                const activity = form.querySelector('input[name="activity"]').value;
                
                // Set the activity in the main form's select element
                activitySelect.value = activity;
                
                // Update other form fields
                const mainForm = document.querySelector('form[action="{{ url_for('main.start_new_task') }}"]');
                const projectInputs = mainForm.querySelectorAll('input[name="project"]');
                const projectValue = form.querySelector('input[name="project"]').value;
                projectInputs.forEach(input => {
                    if (input.value === projectValue) {
                        input.checked = true;
                    }
                });
                mainForm.querySelector('input[name="house_number"]').value = form.querySelector('input[name="house_number"]').value;
                const moduleInputs = mainForm.querySelectorAll('input[name="n_modulo"]');
                const moduleValue = form.querySelector('input[name="n_modulo"]').value;
                moduleInputs.forEach(input => {
                    if (input.value === moduleValue) {
                        input.checked = true;
                    }
                });
                
                // Submit the main form
                mainForm.submit();
            });
        });

        // Handle main form submission
        const mainForm = document.querySelector('form[action="{{ url_for('main.start_new_task') }}"]');
        mainForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validate that an activity is selected
            const activitySelect = this.querySelector('select[name="activity"]');
            if (!activitySelect.value) {
                alert('Por favor, seleccione una actividad.');
                return;
            }
            
            // Validate that a project is selected
            const projectInputs = this.querySelectorAll('input[name="project"]');
            const selectedProject = Array.from(projectInputs).find(input => input.checked);
            if (!selectedProject) {
                alert('Por favor, seleccione un proyecto.');
                return;
            }
            
            // Validate that a module number is selected
            const moduleInputs = this.querySelectorAll('input[name="n_modulo"]');
            const selectedModule = Array.from(moduleInputs).find(input => input.checked);
            if (!selectedModule) {
                alert('Por favor, seleccione un número de módulo.');
                return;
            }
            
            // If all validations pass, submit the form
            this.submit();
        });
    });
</script>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function updateModuloButtons(numberOfModules) {
            var moduloButtons = $('#moduloButtons');
            moduloButtons.empty();
            for (var i = 1; i <= numberOfModules; i++) {
                var checked = (i == {{ last_n_modulo|default(1) }}) ? 'checked' : '';
                moduloButtons.append(`
                    <div>
                        <input type="radio" name="n_modulo" id="modulo${i}" value="${i}" ${checked} required>
                        <label for="modulo${i}">${i}</label>
                    </div>
                `);
            }
        }

        $('input[name="project"]').change(function() {
            var project = $(this).val();
            $.getJSON('/get_project_details/' + project, function(data) {
                var numberOfModules = data.num_modulos || 3;
                updateModuloButtons(numberOfModules);
            });
        });

        var initialNumberOfModules = {{ num_modulos }};
        updateModuloButtons(initialNumberOfModules);

        var selectedProject = $('input[name="project"]:checked');
        if (selectedProject.length > 0) {
            selectedProject.change();
        }
    });
</script>
{% endblock %}
